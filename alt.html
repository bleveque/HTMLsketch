<!DOCTYPE html>
<html lang="en">
<title>Index3</title>
<head>
	<meta charset="utf-8">
	<script src="raphael.js"></script>
	<script src="jquery.js"></script>
	<!--<script src="dtools3.js"></script>-->
	<style>
		#canv
		{
			position:absolute;
			left:10px;
			top:25px;
			height:500px;
			width:500px;
			border:10px solid blue;
			z-index:0
		}
		#clear_button
		{
		    position:absolute;
		    top:470px;
		    left:550px;
		    width:80px;
		    height:40px;
		}
		.color_options
		{
		    position:absolute;
		    top:530px;
		    left:700px;
		}
		.color_option
		{
		    margin:5px;
		    width:50px;
		}
		#draw_options
		{
		    position:absolute;
		    top:120px;
		    left:550px;
		}
		#ellipse_button
		{
		    position:absolute;
		    top:20px;
		    left:690px;
		    width:80px;
		    height:40px;
		}
		#eraser_button
		{
		    position:absolute;
		    top:70px;
		    left:550px;
		    padding-top:4px;
		    padding-left:3px;
		    width:40px;
		    height:40px;
		}
		#manip_shapes_button
		{
		    position:absolute;
		    top:70px;
		    left:600px;
		    padding-top:4px;
		    padding-left:3px;
		    width:170px;
		    height:40px;
		}
		#manip_marquee_button
		{
		    position:absolute;
		    top:70px;
		    left:780px;
		    padding-top:4px;
		    padding-left:3px;
		    width:170px;
		    height:40px;
		}
		#marquee_button
		{
		    position:absolute;
		    top:20px;
		    left:780px;
		    width:80px;
		    height:40px;
		}
		#mode_div
		{
		    position:absolute;
		    top:550px;
		    left:400px;
		}
		.options
		{
			position:absolute;
			top:600px;
			left:600px;
		}
		#pen_button
		{
		    position:absolute;
		    top:20px;
		    left:550px;
		    padding-top:4px;
		    padding-left:3px;
		    width:40px;
		    height:40px;
		}
		#rect_button
		{
		    position:absolute;
		    top:20px;
		    left:600px;
		    width:80px;
		    height:40px;
		}
		#test_layers_div
		{
		    position:absolute;
		    top:550px;
		    left:20px;
		}
		#toggle_marquees_button
		{
		    position:absolute;
		    top:20px;
		    left:870px;
		    width:80px;
		    height:40px;
		}
	</style>
	<script>
		window.onload = load;
		var paper;
		var mode=0;
		var click;
		var ml=[];
        var xy=[];
        var paths=[];
        var pathObjects=[];
	    var strokeWidth=10;
	    var opacity=1;
	    var marquees=[];
	    var marquees_on=1;

		//if the pointer icon is clicked, switch to default mode (0)
		//if the pen icon is clicked, switch to pen mode (1)
		//if the eraser icon is clicked, switch to eraser mode (2)
		
		function add_attributes(elt)
		{
		    //var strokewidth=document.getElementById("strokewidth");
		    //var strokecolor=document.getElementById("strokecolor");
		    //var fillcolor=document.getElementById("fillcolor");
		    //var fillopacity=document.getElementById("fillopacity");
		    //$("#canvas").mousedown();
		    var canv=document.getElementById("canv");
		    var gl;
		    var resize=0; //if 1, we are in zoom mode rather than pan mode
		    var noglow=0; //if 1, glowing is disabled
		    var origmousex;
		    var origmousey;
		    elt.mouseover(function(){
		        if(!noglow && (mode==0))
		        {
		            gl=elt.glow({"width":15,"color":"#33ff00","opacity":.8});
	            }
		    })
		    elt.mouseout(function(){
		        gl.remove();
		    })
		    elt.attr({
		        "stroke-width":5,
		        "stroke":"#222222",
		        "fill":"#ffff00",
		        "fill-opacity":.5
		    });
		    
		    //drag(move, start, stop,...)
		    elt.drag(function(dx,dy,mousex,mousey){
		        if(!mode)
		        {
		            this.toFront();
    		        if(!resize)
    		        {
    		            //drag an element
    		            var currx=parseInt(this.data("currx"));//x position at the start of drag
        		        var curry=parseInt(this.data("curry"));
            		    var xpos=currx+dx; //to get new x position, just add dx
            		    var ypos=curry+dy;
        		        this.attr({
        		            cx:xpos+parseInt(this.data("curr_rx")), //xcenter is left+xradius
        		            cy:ypos+parseInt(this.data("curr_ry")), //ycenter is top+yradius
        		            x:xpos,
        		            y:ypos
        		        });
        		    }
        		    else
        		    {
        		        //resize an element
        		        var bbox=this.getBBox();
        		        this.attr({
        		            cx:bbox.x+bbox.width*0.5+(mousex-origmousex)*0.5,
        		            cy:bbox.y+bbox.height*0.5+(mousey-origmousey)*0.5,
        		            rx:bbox.width/2.0+(mousex-origmousex)*0.5,
        		            ry:bbox.height/2.0+(mousey-origmousey)*0.5,
        		            width:bbox.width+mousex-origmousex,
        		            height:bbox.height+mousey-origmousey
        		        });
        		    }
        		    origmousex=mousex;
        		    origmousey=mousey;
    		    }
		    },function(x,y){
		        if(!mode)
		        {
		            origmousex=x;
    		        origmousey=y;
    		        var bbox=this.getBBox();
    		        document.getElementById("test_layers_div").innerHTML="x = "+x+"<br /> bbox.x = "+(bbox.x)+"<br /> y = "+y+"<br /> bbox.y = "+(bbox.y);
    		        if((x>(bbox.x+bbox.width*0.75)) && (y>(bbox.y+bbox.height*0.75)))
                    {
                        resize=1;
                    }
    		        gl.remove();
    		        noglow=1;
    		        this.animate({opacity:.25},500,"<>");
		        }
		    },function(){
		        if(!mode)
		        {
		            this.data("currx",this.getBBox().x); //reset data using bounding box coords
    		        this.data("curry",this.getBBox().y);
    		        this.data("curr_rx",this.getBBox().width/2.0);
    		        this.data("curr_ry",this.getBBox().height/2.0);
    		        noglow=0;
    		        resize=0;
    		        this.animate({opacity:1},500,"<>");
		        }
		    });   
		}
		
		function add_marq_attributes(marq)
		{
		    var elt=marq.rc;
		    var canv=document.getElementById("canv");
		    var gl;
		    var resize=0; //if 1, we are in zoom mode rather than pan mode
		    var noglow=0; //if 1, glowing is disabled
		    var origmousex;
		    var origmousey;
		    var w=parseInt($('#canv').css("width"));
    	    var h=parseInt($('#canv').css("height"));
		    
		    elt.mouseover(function(){
		        if(!noglow && (mode==3))
		        {
		            gl=elt.glow({"width":15,"color":"#33ff00","opacity":.8});
	            }
		    })
		    elt.mouseout(function(){
		        gl.remove();
		    })
		    elt.attr({
		        "stroke-width":5,
		        "stroke":"#222222",
		        "fill":"#ffff00",
		        "fill-opacity":.5
		    });
		    
		    //drag(move, start, stop,...)
		    elt.drag(function(dx,dy,mousex,mousey){
		        //onmove
		        if(mode==3)
		        {
		            this.toFront();
		            var bbox=this.getBBox();
    		        if(!resize)
    		        {
    		            //drag an element
    		            var currx=parseInt(this.data("currx"));//x position at the start of drag
        		        var curry=parseInt(this.data("curry"));
            		    var xpos=currx+dx; //to get new x position, just add dx
            		    var ypos=curry+dy;
            		    // marq.rn.attr({
            		    //                            height:ypos
            		    //                        });
            		    //                        marq.re.attr({
            		    //                            width:w-xpos-bbox.width
            		    //                        });
            		    //                        marq.rs.attr({
            		    //                            height:h-ypos-bbox.height
            		    //                        });
            		    //                        marq.rw.attr({
            		    //                            width:xpos
            		    //                        })
        		        this.attr({
        		            x:xpos,
        		            y:ypos
        		        });
        		        marq.rn.attr({
        		            height:ypos
        		        });
        		        marq.re.attr({
        		            x:xpos+bbox.width,
        		            width:w-(xpos+bbox.width)
        		        });
        		        marq.rs.attr({
        		            y:ypos+bbox.height,
        		            height:h-(ypos+bbox.height)
        		        })
        		        marq.rw.attr({
        		            width:xpos
        		        })
        		        
        		    }
        		    else
        		    {
        		        //resize an element
        		        this.attr({
        		            width:bbox.width+mousex-origmousex,
        		            height:bbox.height+mousey-origmousey
        		        });
        		        marq.rs.attr({
        		            y:bbox.y+bbox.height+mousey-origmousey,
        		            height:h-(bbox.y+bbox.height+mousey-origmousey)
        		        });
        		        marq.re.attr({
        		            x:bbox.x+bbox.width+mousex-origmousex,
        		            width:w-(bbox.x+bbox.width+mousex-origmousex)
        		        })
        		    }
        		    origmousex=mousex;
        		    origmousey=mousey;
    		    }
		    },function(x,y){
		        //onstart
		        if(mode==3)
		        {
		            origmousex=x;
    		        origmousey=y;
    		        var bbox=this.getBBox();
    		        document.getElementById("test_layers_div").innerHTML="x = "+x+"<br /> bbox.x = "+(bbox.x)+"<br /> y = "+y+"<br /> bbox.y = "+(bbox.y);
    		        if((x>(bbox.x+bbox.width*0.75)) && (y>(bbox.y+bbox.height*0.75)))
                    {
                        resize=1;
                    }
    		        gl.remove();
    		        noglow=1;
    		        this.animate({opacity:.25},500,"<>");
		        }
		    },function(){
		        //onend
		        if(mode==3)
		        {
		            this.data("currx",this.getBBox().x); //reset data using bounding box coords
    		        this.data("curry",this.getBBox().y);
    		        marq.re.data("currx",this.getBBox().x+this.getBBox().width);
    		        marq.rs.data("curry",this.getBBox().y+this.getBBox().height);
    		        noglow=0;
    		        resize=0;
    		        this.animate({opacity:1},500,"<>");
		        }
		    });   
		}
		
		function add_rectangle()
		{
		    set_mode(0);
		    var x=Math.floor(Math.random()*300);
		    var y=Math.floor(Math.random()*300);
		    rect=paper.rect(x,y,50,50);
		    rect.data("currx",x);
		    rect.data("curry",y);
		    add_attributes(rect);
		}
		
		function add_ellipse()
		{
		    set_mode(0);
		    var x=Math.floor(Math.random()*300);
		    var y=Math.floor(Math.random()*300);
		    var rx=20+Math.floor(Math.random()*40);
		    var ry=20+Math.floor(Math.random()*40);
		    ellipse=paper.ellipse(x,y,rx,ry);
		    ellipse.data("currx",ellipse.getBBox().x);
		    ellipse.data("curry",ellipse.getBBox().y);
		    ellipse.data("curr_rx",rx);
		    ellipse.data("curr_ry",ry);
		    add_attributes(ellipse);
		}
		
		function add_marquee()
		{
		    set_mode(3);
    	    var topx=40+Math.floor(Math.random()*10), botx=80+Math.floor(Math.random()*10), topy=40+Math.floor(Math.random()*10), boty=80+Math.floor(Math.random()*10);
    	    //var topx=40, botx=80, topy=40, boty=80;
    	    var w=parseInt($('#canv').css("width"));
    	    var h=parseInt($('#canv').css("height"));
    	    var rn=paper.rect(0,0,w,topy);
    	    rn.data("currx",0);
    	    rn.data("curry",0);
    	    var re=paper.rect(botx,0,w-botx,h);
    	    re.data("currx",botx);
    	    re.data("curry",0);
    	    var rs=paper.rect(0,boty,w,h-boty);
    	    rs.data("currx",0);
    	    rs.data("curry",boty);
    	    var rw=paper.rect(0,0,topx,h);
    	    rw.data("currx",0);
    	    rw.data("curry",0);
    	    var rc=paper.rect(topx,topy,botx-topx,boty-topy);
    	    rc.data("currx",topx);
    	    rc.data("curry",topy);
    	    var m=new marquee(rn,re,rs,rw,rc);
    	    add_marq_attributes(m);
    	    marquees.push(m);
    	    show_marquees();
    	    marquees_on=1;
    	    // var elt=document.getElementById("test_layers_div");
    	    //             elt.innerHTML=marquees;
        }
        
        function hide_marquees()
        {
            var i;
            var len=marquees.length;
            for(i=0;i<len;i++)
            {
                marquees[i].rn.hide();
                marquees[i].re.hide();
                marquees[i].rs.hide();
                marquees[i].rw.hide();
                marquees[i].rc.hide();
            }
        }
        
        function show_marquees()
        {
            var i;
            var len=marquees.length;
            for(i=0;i<len;i++)
            {
                var m=marquees[i];
                m.rn.show();
                m.re.show();
                m.rs.show();
                m.rw.show();
                m.rc.show();
            }
        }

        function updateSpot(array, startX, startY, endX, endY)
        {
    	var canvasWidth = $("#canvas").width();
    	var canvasHeight = $("#canvas").height();
    	array[0].attr({
    	    x: 0,
    	    y: 0,
    	    width: canvasWidth,
    	    height: Math.min(endY,startY),
    	});
    	array[1].attr({
    	    x: 0,
    	    y: Math.min(endY,startY),
    	    width: Math.min(startX, endX),
    	    height: Math.abs(endY-startY)
    	});
    	array[2].attr({
    	    x: Math.max(endX, startX),
    	    y: Math.min(endY, startY),
    	    width: canvasHeight - Math.max(startX, endX),
    	    height: Math.abs(endY-startY)
    	});
    	array[3].attr({
    	    x: 0,
    	    y: Math.max(endY, startY),
    	    width: canvasWidth,
    	    height: canvasHeight - Math.max(endY, startY)
    	});
        }
		
        function drawPaths()
        {
           
            var paths;
            //removes all objects in pathObjects to be redrawn
            var len = pathObjects.length;
            for(var i = 0; i < pathObjects.length; i++)
            { //removes paths from canvas
                pathObjects[i].remove();
            }
            for(var i = 0; i < len; i++)
            { //clears the pathObjects array
                pathObjects.shift();
            }
            for(var i = 0; i < ml.length; i++)
            { //constructs the path
                if(ml[i] !== 'X')
                {
                    paths += ml[i] + xy[i][0] + ',' + xy[i][1];;
                }
            }
            if(paths.length > 0)
            {
                var path = paths.split('M');
            }
            for(var i = 1; i < path.length; i++)
            {
                var drawing = paper.path('M'+path[i]);
                drawing.attr({
                "stroke-width": strokeWidth,
                "stroke-opacity": opacity,
                "stroke-linejoin":"round",
                "stroke-linecap":"round"
                })
                pathObjects.push(drawing);
            }       
        }
        
        function erase(location)
        {
     	    var range=5;
     	    for(var i = 0; i < xy.length; i++)
     	    {
     	        if(location[0] - range <= xy[i][0] && xy[i][0] <= location[0] + range)
     	        {
     		        if(location[1] - range <= xy[i][1] && xy[i][1] <= location[1] + range)
     		        {
     		            if(ml[i+1] === 'L')
     		            {
     			            ml[i+1] = 'M';
     		            }
     		            ml.splice(i,1);
     		            xy.splice(i,1);
     		            drawPaths();
     		        }
     	        }
     	    }
        }
        
		function load()
		{
		    paper=Raphael(document.getElementById("canv"),500,500);
            set_up_icons();
            set_mode(0);
            $("#canv").mousedown(function(e)
            {
        	    click = true;
        	    switch(mode)
            	{
            	case 1:
            	    ml.push('M');
            	    xy.push([e.offsetX,e.offsetY]);
            	    ml.push('L');
            	    xy.push([e.offsetX,e.offsetY]);
            	    drawPaths();
            	    document.getElementById("test_layers_div").innerHTML="ml = "+ml+"<br /> xy = "+xy;
            	    break;
            	case 2:
            	    erase([e.offsetX,e.offsetY]);
            	    break;
            	}
            }).mouseup(function()
            {
                click = false;
            }).mouseleave(function()
            {
             if(click === true)
             {
                 click = false;
             }
            }).mousemove(function(e)
            {
                if(mode)
                {
                    $("#canv").css('cursor','crosshair');
                }
                if(click === false)
                    return;
                switch(mode)
                {
                    case 1:
                        ml.push('L');
                        xy.push([e.offsetX,e.offsetY]);
                        drawPaths();
                        break;
                    case 2:
                        erase([e.offsetX,e.offsetY]);
                        break;
                }
            }).hover(function(e)
            {
                if(mode==1)
                {
                    $("#canv").css('cursor', "pointer");
                }
         });
		};
		
		function marquee(rectN,rectE,rectS,rectW,rectC)
		{
		    //constructor for the marquee class
		    this.rn=rectN;
		    this.re=rectE;
		    this.rs=rectS;
		    this.rw=rectW;
		    this.rc=rectC;
		}
		
		function remove_all()
		{
		    //removes all Raphael elements from the canvas
            ml=[];
            xy=[];
            paths=[];
            pathObjects=[];
            marquees=[];
            paper.remove();
            paper=Raphael(document.getElementById("canv"),500,500);
		}
		
		function set_mode(i)
		{
		    i=parseInt(i);
		    if((i<1) || (i>3))
		    {
		        mode=0;
		    }
		    else
		    {
		        mode=i;
		    }
		    var elt=document.getElementById("mode_div");
            switch(mode)
            {
                case 0:
                    elt.innerHTML="mode: shapes";
                    break;
                case 1:
                    elt.innerHTML="mode: pen";
                    break;
                case 2:
                    elt.innerHTML="mode: eraser";
                    break;
                case 3:
                    elt.innerHTML="mode: marquee";
                    break;
            }
		}
		
		function set_up_icons()
		{
		   var paper=Raphael(document.getElementById("pen_button"),35,35); paper.path("M13.587,12.074c-0.049-0.074-0.11-0.147-0.188-0.202c-0.333-0.243-0.803-0.169-1.047,0.166c-0.244,0.336-0.167,0.805,0.167,1.048c0.303,0.22,0.708,0.167,0.966-0.091l-7.086,9.768l-2.203,7.997l6.917-4.577L26.865,4.468l-4.716-3.42l-1.52,2.096c-0.087-0.349-0.281-0.676-0.596-0.907c-0.73-0.529-1.751-0.369-2.28,0.363C14.721,6.782,16.402,7.896,13.587,12.074zM10.118,25.148L6.56,27.503l1.133-4.117L10.118,25.148zM14.309,11.861c2.183-3.225,1.975-4.099,3.843-6.962c0.309,0.212,0.664,0.287,1.012,0.269L14.309,11.861z").attr({fill: "#000", stroke: "none"});
		   //var paper2=Raphael(document.getElementById("pointer_button"),35,35);
		   //paper2.path("M15.834,29.084 15.834,16.166 2.917,16.166 29.083,2.917z").attr({fill: "#000", stroke:"none"});
	    }
		
		function toggle_marquees()
		{
		    marquees_on=1-marquees_on;
		    if(marquees_on)
		    {
		        show_marquees();
		    }
		    else
		    {
		        hide_marquees();
		    }
		}
		
	</script>
</head>
<body>
<div id="canv"></div>

<button id="pen_button" class="tool_button" type="button"
        onclick="set_mode(1)">pen</button>
        
<button id="rect_button" class="tool_button" type="button"
        onclick="add_rectangle()">+ rect</button>

<button id="ellipse_button" class="tool_button" type="button"
        onclick="add_ellipse()">+ ellipse</button>
        
<button id="marquee_button" class="tool_button" type="button"
        onclick="add_marquee()">+ marquee</button>
        
<button id="toggle_marquees_button" class="tool_button" type="button"
        onclick="toggle_marquees()">toggle marquees</button>
    
        
<button id="manip_shapes_button" class="tool_button" type="button"
        onclick="set_mode(0)">manipulate shapes</button>
        
<button id="manip_marquee_button" class="tool_button" type="button"
        onclick="set_mode(3)">manipulate marquee</button>
        
<button id="eraser_button" class="tool_button" type="button"
        onclick="set_mode(2)">erase</button>

<div id="draw_options">
    Pen color:        
    <input id="pen_color" class="color_input" type="text"
            value="000000" />
    <br />
    Pen opacity:
    <input id="pen_opacity" class="color_input" type="text"
            value="1" />
    <br />
    Rectangle stroke color:
    <input id="rect_stroke_color" class="color_input" type="text"
            value="000000" />
    <br />
    Rectangle stroke opacity:        
    <input id="rect_stroke_opacity" class="color_input" type="text"
            value="1" />
    <br />
    Rectangle fill color:        
    <input id="rect_fill_color" class="color_input" type="text"
            value="ffff00" />
    <br />
    Rectangle fill opacity:        
    <input id="rect_fill_opacity" class="color_input" type="text"
            value=".5" />
    <br />
    Ellipse stroke color:
    <input id="ellipse_stroke_color" class="color_input" type="text"
            value="000000" />
    <br />
    Ellipse stroke opacity:        
    <input id="ellipse_stroke_opacity" class="color_input" type="text"
            value="1" />
    <br />
    Ellipse fill color:        
    <input id="ellipse_fill_color" class="color_input" type="text"
            value="ffff00" />
    <br />
    Ellipse fill opacity:        
    <input id="ellipse_fill_opacity" class="color_input" type="text"
            value=".5" />
</div>

<div id="mode_div">mode: shapes</div>

<button id="clear_button" type="button"
        onclick='remove_all()'>Clear All</button>

<div id="test_layers_div"><div>
</body>
</html>
